# Reusable workflow for projects using mise
# This workflow is language-agnostic and expects the following tasks to be defined in mise.toml:
#   - version: Generate version string (e.g., YYYYMMDD-gitsha)
#   - Individual tasks: Configurable quality checks (e.g., tidy-check, fmt-check, lint, vet, check, test-race for Go projects)
#   - build: Build task for your project
# Projects can customize behavior through mise.toml without modifying this workflow

name: Build and Deploy with mise

on:
  workflow_call:
    inputs:
      mise-task-version:
        description: 'mise task name for version generation'
        required: false
        type: string
        default: 'version'
      mise-setup-tasks:
        description: 'JSON array of mise setup tasks to run sequentially before other tasks (e.g., ["install:ts", "install:go"])'
        required: false
        type: string
        default: '[]'
      mise-tasks:
        description: 'JSON array of mise tasks to run in parallel (e.g., ["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"])'
        required: false
        type: string
        default: '["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"]'
      mise-task-build:
        description: 'mise task name for building'
        required: false
        type: string
        default: 'build'
      builds-docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: true
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      docker-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      deploys-to-nais:
        description: 'Deploy to NAIS clusters'
        required: false
        type: boolean
        default: false
      nais-resource:
        description: 'Path to NAIS application manifest'
        required: false
        type: string
        default: '.nais/app.yaml'
      nais-vars:
        description: 'Path to NAIS environment variables. Use {cluster} placeholder for multi-cluster (e.g., .nais/{cluster}.yaml)'
        required: false
        type: string
        default: '.nais/{cluster}.yaml'
      nais-clusters:
        description: 'JSON array of NAIS clusters to deploy to'
        required: false
        type: string
        default: '["dev-gcp"]'
      nais-team:
        description: 'NAIS team name'
        required: false
        type: string
        default: 'nais'
      deploy-pr-to-dev:
        description: 'Deploy pull requests to dev environment'
        required: false
        type: boolean
        default: false
      creates-git-tag:
        description: 'Create and push git tag'
        required: false
        type: boolean
        default: false
      artifact-registry:
        description: 'Docker registry for artifacts'
        required: false
        type: string
        default: 'europe-north1-docker.pkg.dev'
      artifact-repo:
        description: 'Docker repository name'
        required: false
        type: string
        default: 'nais-io/nais/images'
      runner-size:
        description: 'GitHub Actions runner size'
        required: false
        type: string
        default: 'ubuntu-latest'
      runner-size-docker:
        description: 'GitHub Actions runner size for Docker builds'
        required: false
        type: string
        default: 'ubuntu-latest'
      working-directory:
        description: 'Working directory for monorepo support'
        required: false
        type: string
        default: '.'
    secrets:
      NAIS_IO_WORKLOAD_IDENTITY_PROVIDER:
        required: false
    outputs:
      version:
        description: 'Generated version string'
        value: ${{ jobs.meta.outputs.version }}
      name:
        description: 'Repository name'
        value: ${{ jobs.meta.outputs.name }}
      image:
        description: 'Full Docker image reference with tag'
        value: ${{ jobs.meta.outputs.image }}

jobs:
  meta:
    name: Metadata
    runs-on: ${{ inputs.runner-size }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.name.outputs.name }}
      image-base: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}
      image: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}:${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
        with:
          experimental: true
      - id: version
        env:
          MISE_TASK_VERSION: ${{ inputs.mise-task-version }}
        run: echo "version=$(mise run "$MISE_TASK_VERSION")" >> ${GITHUB_OUTPUT}
      - id: name
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: echo "name=$REPO_NAME" >> ${GITHUB_OUTPUT}

  setup:
    name: Setup
    if: ${{ inputs.mise-setup-tasks != '[]' }}
    runs-on: ${{ inputs.runner-size }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
        with:
          experimental: true
      - name: Run setup tasks
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done

  lint:
    name: Check
    needs: [setup]
    if: ${{ always() && (needs.setup.result == 'success' || needs.setup.result == 'skipped') }}
    strategy:
      fail-fast: false
      matrix:
        task: ${{ fromJson(inputs.mise-tasks) }}
    runs-on: ${{ inputs.runner-size }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
        with:
          experimental: true
      - name: Run setup tasks
        if: ${{ inputs.mise-setup-tasks != '[]' }}
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done
      - name: Run ${{ matrix.task }}
        env:
          MISE_TASK: ${{ matrix.task }}
        run: mise run "$MISE_TASK"

  build:
    name: Build
    needs: [setup]
    if: ${{ always() && (needs.setup.result == 'success' || needs.setup.result == 'skipped') }}
    runs-on: ${{ inputs.runner-size }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
        with:
          experimental: true
      - name: Run setup tasks
        if: ${{ inputs.mise-setup-tasks != '[]' }}
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done
      - env:
          MISE_TASK_BUILD: ${{ inputs.mise-task-build }}
        run: mise run "$MISE_TASK_BUILD"

  docker:
    name: Build Docker Image
    if: ${{ inputs.builds-docker }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size-docker }}
    needs: [meta, lint, build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # ratchet:docker/setup-buildx-action@v3
        with:
          install: true
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # ratchet:docker/login-action@v3
        if: steps.auth.conclusion == 'success'
        with:
          registry: ${{ inputs.artifact-registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}
      - id: metadata
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # ratchet:docker/metadata-action@v5
        with:
          images: ${{ needs.meta.outputs.image-base }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=sha
            type=raw,value=${{ needs.meta.outputs.version }}
      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # ratchet:docker/build-push-action@v6
        with:
          context: ${{ inputs.working-directory != '.' && format('{0}/{1}', inputs.working-directory, inputs.docker-context) || inputs.docker-context }}
          file: ${{ inputs.working-directory != '.' && format('{0}/{1}', inputs.working-directory, inputs.dockerfile-path) || inputs.dockerfile-path }}
          push: ${{ github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success' }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to NAIS
    if: ${{ inputs.deploys-to-nais && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    needs: [meta, docker]
    strategy:
      matrix:
        cluster: ${{ fromJson(inputs.nais-clusters) }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - name: Resolve vars path
        id: vars
        env:
          NAIS_VARS_PATTERN: ${{ inputs.nais-vars }}
          CLUSTER: ${{ matrix.cluster }}
        run: |
          VARS_PATH="${NAIS_VARS_PATTERN//\{cluster\}/$CLUSTER}"
          echo "path=$VARS_PATH" >> $GITHUB_OUTPUT
      - uses: nais/deploy/actions/deploy@fa754451577294aae42872a69b888b3470478ec1 # ratchet:nais/deploy/actions/deploy@v2
        env:
          CLUSTER: ${{ matrix.cluster }}
          TEAM: ${{ inputs.nais-team }}
          RESOURCE: ${{ inputs.nais-resource }}
          VARS: ${{ steps.vars.outputs.path }}
          VAR: image=${{ needs.meta.outputs.image }}

  deploy-pr:
    name: Deploy PR to dev
    if: ${{ inputs.deploy-pr-to-dev && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: [meta, docker]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - uses: nais/deploy/actions/deploy@fa754451577294aae42872a69b888b3470478ec1 # ratchet:nais/deploy/actions/deploy@v2
        env:
          CLUSTER: dev-gcp
          TEAM: ${{ inputs.nais-team }}
          RESOURCE: ${{ inputs.nais-resource }}
          VARS: .nais/dev-gcp.yaml
          VAR: image=${{ needs.meta.outputs.image }}

  tag:
    name: Create Git Tag
    if: ${{ inputs.creates-git-tag && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: meta
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4
      - env:
          VERSION: ${{ needs.meta.outputs.version }}
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"
