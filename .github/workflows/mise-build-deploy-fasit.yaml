# Reusable workflow for projects using mise
# This workflow is language-agnostic and expects the following tasks to be defined in mise.toml:
#   - version: Generate version string (e.g., YYYYMMDD-gitsha)
#   - Individual tasks: Configurable quality checks (e.g., tidy-check, fmt-check, lint, vet, check, test-race for Go projects)
#   - build: Build task for your project
# Projects can customize behavior through mise.toml without modifying this workflow

name: Build and Deploy with mise to Fasit

on:
  workflow_call:
    inputs:
      mise-task-version:
        description: 'mise task name for version generation'
        required: false
        type: string
        default: 'version'
      mise-setup-tasks:
        description: 'JSON array of mise setup tasks to run sequentially before other tasks (e.g., ["install:ts", "install:go"])'
        required: false
        type: string
        default: '[]'
      mise-tasks:
        description: 'JSON array of mise tasks to run in parallel (e.g., ["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"])'
        required: false
        type: string
        default: '["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"]'
      mise-task-build:
        description: 'mise task name for building'
        required: false
        type: string
        default: 'build'
      builds-docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: true
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      docker-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      builds-chart:
        description: 'Build and push Helm chart'
        required: false
        type: boolean
        default: false
      chart-path:
        description: 'Path to Helm chart directory'
        required: false
        type: string
        default: './charts'
      deploys-to-fasit:
        description: 'Deploy to Fasit'
        required: false
        type: boolean
        default: false
      creates-git-tag:
        description: 'Create and push git tag'
        required: false
        type: boolean
        default: false
      artifact-registry:
        description: 'Docker registry for artifacts'
        required: false
        type: string
        default: 'europe-north1-docker.pkg.dev'
      artifact-repo:
        description: 'Docker repository name'
        required: false
        type: string
        default: 'nais-io/nais/images'
      chart-repo:
        description: 'Helm chart repository name'
        required: false
        type: string
        default: 'nais-io/nais/charts'
      runner-size:
        description: 'GitHub Actions runner size'
        required: false
        type: string
        default: 'ubuntu-latest'
      runner-size-docker:
        description: 'GitHub Actions runner size for Docker builds'
        required: false
        type: string
        default: 'ubuntu-latest-16-cores'
      helm-version:
        description: 'Helm version to use'
        required: false
        type: string
        default: 'v3.16.3'
    secrets:
      NAIS_IO_WORKLOAD_IDENTITY_PROVIDER:
        required: false
    outputs:
      version:
        description: 'Generated version string'
        value: ${{ jobs.meta.outputs.version }}
      name:
        description: 'Repository name'
        value: ${{ jobs.meta.outputs.name }}
      image:
        description: 'Full Docker image reference with tag'
        value: ${{ jobs.meta.outputs.image }}

jobs:
  meta:
    name: Metadata
    runs-on: ${{ inputs.runner-size }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.name.outputs.name }}
      image-base: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}
      image: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}:${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # ratchet:jdx/mise-action@v2
      - id: version
        env:
          MISE_TASK_VERSION: ${{ inputs.mise-task-version }}
        run: echo "version=$(mise run "$MISE_TASK_VERSION")" >> ${GITHUB_OUTPUT}
      - id: name
        run: echo "name=${{ github.event.repository.name }}" >> ${GITHUB_OUTPUT}

  setup:
    name: Setup
    if: ${{ inputs.mise-setup-tasks != '[]' }}
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # ratchet:jdx/mise-action@v2
      - name: Run setup tasks
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done

  lint:
    name: Check
    needs: [setup]
    if: ${{ always() && (needs.setup.result == 'success' || needs.setup.result == 'skipped') }}
    strategy:
      fail-fast: false
      matrix:
        task: ${{ fromJson(inputs.mise-tasks) }}
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # ratchet:jdx/mise-action@v2
      - name: Run setup tasks
        if: ${{ inputs.mise-setup-tasks != '[]' }}
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done
      - name: Run ${{ matrix.task }}
        env:
          MISE_TASK: ${{ matrix.task }}
        run: mise run "$MISE_TASK"

  build:
    name: Build
    needs: [setup]
    if: ${{ always() && (needs.setup.result == 'success' || needs.setup.result == 'skipped') }}
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/pnpm-lock.yaml') != ''
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        if: hashFiles('**/package-lock.json') != ''
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # ratchet:jdx/mise-action@v2
      - name: Run setup tasks
        if: ${{ inputs.mise-setup-tasks != '[]' }}
        env:
          MISE_SETUP_TASKS: ${{ inputs.mise-setup-tasks }}
        run: |
          echo "$MISE_SETUP_TASKS" | jq -r '.[]' | while read task; do
            echo "Running setup task: $task"
            mise run "$task"
          done
      - env:
          MISE_TASK_BUILD: ${{ inputs.mise-task-build }}
        run: mise run "$MISE_TASK_BUILD"

  docker:
    name: Build Docker Image
    if: ${{ inputs.builds-docker }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size-docker }}
    needs: [meta, lint, build]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # ratchet:docker/setup-buildx-action@v3
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # ratchet:docker/login-action@v3
        if: steps.auth.conclusion == 'success'
        with:
          registry: ${{ inputs.artifact-registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}
      - id: metadata
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # ratchet:docker/metadata-action@v5
        with:
          images: ${{ needs.meta.outputs.image-base }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=sha
            type=raw,value=${{ needs.meta.outputs.version }}
      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # ratchet:docker/build-push-action@v6
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile-path }}
          push: ${{ github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success' }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  chart:
    name: Build Helm Chart
    if: ${{ inputs.builds-chart }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size }}
    needs: meta
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - name: Update Chart metadata
        env:
          CHART_PATH: ${{ inputs.chart-path }}
          CHART_NAME: ${{ needs.meta.outputs.name }}
          VERSION: ${{ needs.meta.outputs.version }}
        run: |
          CHART_DIR="${CHART_PATH}/${CHART_NAME}"
          if [ -f "${CHART_DIR}/Chart.yaml" ]; then
            sed -i "s/^version:.*$/version: ${VERSION}/g" "${CHART_DIR}/Chart.yaml"
            sed -i "s/^appVersion:.*$/appVersion: ${VERSION}/g" "${CHART_DIR}/Chart.yaml"
          fi
          if [ -f "${CHART_DIR}/values.yaml" ]; then
            sed -i "s/^    tag:.*$/    tag: ${VERSION}/g" "${CHART_DIR}/values.yaml"
          fi
      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token
      - uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f # ratchet:google-github-actions/setup-gcloud@v2
        if: steps.auth.conclusion == 'success'
      - if: steps.auth.conclusion == 'success'
        run: echo '${{ steps.auth.outputs.access_token }}' | docker login -u oauth2accesstoken --password-stdin https://${{ inputs.artifact-registry }}
      - uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # ratchet:azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}
      - env:
          CHART_PATH: ${{ inputs.chart-path }}
          CHART_NAME: ${{ needs.meta.outputs.name }}
        run: helm package "${CHART_PATH}/${CHART_NAME}" -d "${CHART_PATH}"
      - if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success'
        env:
          CHART_PATH: ${{ inputs.chart-path }}
          ARTIFACT_REGISTRY: ${{ inputs.artifact-registry }}
          CHART_REPO: ${{ inputs.chart-repo }}
        run: helm push "${CHART_PATH}"/*.tgz oci://${ARTIFACT_REGISTRY}/${CHART_REPO}

  rollout:
    name: Deploy to Fasit
    if: ${{ inputs.deploys-to-fasit && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: fasit-deploy
    permissions:
      id-token: write
    needs: [meta, docker, chart]
    steps:
      - uses: nais/fasit-deploy@8727ed1c7a5a465e837873e6016a9a692a6b874a # ratchet:nais/fasit-deploy@v2
        env:
          ARTIFACT_REGISTRY: ${{ inputs.artifact-registry }}
          CHART_REPO: ${{ inputs.chart-repo }}
          CHART_NAME: ${{ needs.meta.outputs.name }}
          VERSION: ${{ needs.meta.outputs.version }}
        with:
          chart: oci://${{ env.ARTIFACT_REGISTRY }}/${{ env.CHART_REPO }}/${{ env.CHART_NAME }}
          version: ${{ env.VERSION }}

  tag:
    name: Create Git Tag
    if: ${{ inputs.creates-git-tag && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: meta
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - env:
          VERSION: ${{ needs.meta.outputs.version }}
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"
