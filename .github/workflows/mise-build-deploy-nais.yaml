# Reusable workflow for projects using mise
# This workflow is language-agnostic and expects the following tasks to be defined in mise.toml:
#   - version: Generate version string (e.g., YYYYMMDD-gitsha)
#   - Individual tasks: Configurable quality checks (e.g., tidy-check, fmt-check, lint, vet, check, test-race for Go projects)
#   - build: Build task for your project
# Projects can customize behavior through mise.toml without modifying this workflow

name: Build and Deploy with mise

on:
  workflow_call:
    inputs:
      mise-task-version:
        description: 'mise task name for version generation'
        required: false
        type: string
        default: 'version'
      mise-tasks:
        description: 'JSON array of mise tasks to run in parallel (e.g., ["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"])'
        required: false
        type: string
        default: '["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"]'
      mise-task-build:
        description: 'mise task name for building'
        required: false
        type: string
        default: 'build'
      builds-docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: true
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      docker-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      deploys-to-nais:
        description: 'Deploy to NAIS clusters'
        required: false
        type: boolean
        default: false
      nais-resource:
        description: 'Path to NAIS application manifest'
        required: false
        type: string
        default: '.nais/app.yaml'
      nais-vars:
        description: 'Path to NAIS environment variables (use ${{ matrix.cluster }} for multi-cluster)'
        required: false
        type: string
        default: '.nais/${{ matrix.cluster }}.yaml'
      nais-clusters:
        description: 'JSON array of NAIS clusters to deploy to'
        required: false
        type: string
        default: '["dev-gcp"]'
      nais-team:
        description: 'NAIS team name'
        required: false
        type: string
        default: 'nais'
      deploy-pr-to-dev:
        description: 'Deploy pull requests to dev environment'
        required: false
        type: boolean
        default: false
      creates-git-tag:
        description: 'Create and push git tag'
        required: false
        type: boolean
        default: false
      artifact-registry:
        description: 'Docker registry for artifacts'
        required: false
        type: string
        default: 'europe-north1-docker.pkg.dev'
      artifact-repo:
        description: 'Docker repository name'
        required: false
        type: string
        default: 'nais-io/nais/images'
      runner-size:
        description: 'GitHub Actions runner size'
        required: false
        type: string
        default: 'ubuntu-latest'
      runner-size-docker:
        description: 'GitHub Actions runner size for Docker builds'
        required: false
        type: string
        default: 'ubuntu-latest-16-cores'
    secrets:
      NAIS_IO_WORKLOAD_IDENTITY_PROVIDER:
        required: false
    outputs:
      version:
        description: 'Generated version string'
        value: ${{ jobs.meta.outputs.version }}
      name:
        description: 'Repository name'
        value: ${{ jobs.meta.outputs.name }}
      image:
        description: 'Full Docker image reference with tag'
        value: ${{ jobs.meta.outputs.image }}

jobs:
  meta:
    name: Metadata
    runs-on: ${{ inputs.runner-size }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.name.outputs.name }}
      image-base: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}
      image: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}:${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
      - id: version
        run: echo "version=$(mise run ${{ inputs.mise-task-version }})" >> ${GITHUB_OUTPUT}
      - id: name
        run: echo "name=${{ github.event.repository.name }}" >> ${GITHUB_OUTPUT}

  lint:
    name: Check
    strategy:
      fail-fast: false
      matrix:
        task: ${{ fromJson(inputs.mise-tasks) }}
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
      - name: Run ${{ matrix.task }}
        run: mise run ${{ matrix.task }}

  build:
    name: Build
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2
      - run: mise run ${{ inputs.mise-task-build }}

  docker:
    name: Build Docker Image
    if: ${{ inputs.builds-docker }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size-docker }}
    needs: [meta, lint, build]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # ratchet:docker/setup-buildx-action@v3
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # ratchet:docker/login-action@v3
        if: steps.auth.conclusion == 'success'
        with:
          registry: ${{ inputs.artifact-registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}
      - id: metadata
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # ratchet:docker/metadata-action@v5
        with:
          images: ${{ needs.meta.outputs.image-base }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=sha
            type=raw,value=${{ needs.meta.outputs.version }}
      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # ratchet:docker/build-push-action@v6
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile-path }}
          push: ${{ github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success' }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to NAIS
    if: ${{ inputs.deploys-to-nais && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    needs: [meta, docker]
    strategy:
      matrix:
        cluster: ${{ fromJson(inputs.nais-clusters) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: nais/deploy/actions/deploy@bf10eb880baadd930712c2f66e2f57180d3e846f # ratchet:nais/deploy/actions/deploy@v2
        env:
          CLUSTER: ${{ matrix.cluster }}
          TEAM: ${{ inputs.nais-team }}
          RESOURCE: ${{ inputs.nais-resource }}
          VARS: ${{ inputs.nais-vars }}
          VAR: image=${{ needs.meta.outputs.image }}

  deploy-pr:
    name: Deploy PR to dev
    if: ${{ inputs.deploy-pr-to-dev && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: [meta, docker]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - uses: nais/deploy/actions/deploy@bf10eb880baadd930712c2f66e2f57180d3e846f # ratchet:nais/deploy/actions/deploy@v2
        env:
          CLUSTER: dev-gcp
          TEAM: ${{ inputs.nais-team }}
          RESOURCE: ${{ inputs.nais-resource }}
          VARS: .nais/dev-gcp.yaml
          VAR: image=${{ needs.meta.outputs.image }}

  tag:
    name: Create Git Tag
    if: ${{ inputs.creates-git-tag && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: meta
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - run: |
          git tag ${{ needs.meta.outputs.version }}
          git push origin ${{ needs.meta.outputs.version }}
